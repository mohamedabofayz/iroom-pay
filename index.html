<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª iroom pay</title>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        input, button { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #1d4ed8; }
        .history-item { border-right: 4px solid var(--primary); background: #f8fafc; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .history-item a { color: var(--primary); text-decoration: none; font-weight: bold; }
        .header { text-align: center; margin-bottom: 20px; }
        .logout { background: #ef4444; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginSection">
        <div class="header">
            <h2>ğŸ‘‹ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‡ÙˆØ³ØªØ±</h2>
            <p>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</p>
        </div>
        <input type="tel" id="supervisorMobile" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø«Ù„ (5xxxxxxxx)">
        <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="appSection" class="hidden">
        <div class="header">
            <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="displayMobile"></span></h3>
        </div>

        <h4>ğŸ”— Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯</h4>
        <input type="text" id="customerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input type="number" id="invoiceValue" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø³)">
        <button id="createBtn" onclick="createLink()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·</button>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <h4>ğŸ“œ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
        <div id="historyContainer">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

        <button class="logout" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
    // ğŸ”´ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§ ğŸ”´
    const API_URL = 'https://script.google.com/macros/s/AKfycbwRFFkOV2ahGtU5_YDUJiwRrAukvprOVNUmnx9IzTlaZEw2PpmJwSD4Ncl4zbIV83LO/exec';

    let currentSupervisor = '';

    function login() {
        const mobile = document.getElementById('supervisorMobile').value;
        if (mobile.length < 5) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­');
        
        currentSupervisor = mobile;
        document.getElementById('displayMobile').innerText = mobile;
        
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('appSection').classList.remove('hidden');
        
        loadHistory();
    }

    async function createLink() {
        const name = document.getElementById('customerName').value;
        const amount = document.getElementById('invoiceValue').value;

        if (!name || !amount) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const btn = document.getElementById('createBtn');
        btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...';
        btn.disabled = true;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'create_link',
                    supervisorMobile: currentSupervisor,
                    customerName: name,
                    invoiceValue: amount,
                    customerMobile: '' // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ ÙƒØ­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
                })
            });
            const data = await response.json();

            if (data.status === 'success') {
                alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·');
                document.getElementById('customerName').value = '';
                document.getElementById('invoiceValue').value = '';
                loadHistory(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            } else {
                alert('Ø®Ø·Ø£: ' + data.message);
            }
        } catch (e) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
        }
        
        btn.innerText = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·';
        btn.disabled = false;
    }

    async function loadHistory() {
        const container = document.getElementById('historyContainer');
        container.innerHTML = '<p style="text-align:center">ØªØ­Ù…ÙŠÙ„...</p>';

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'get_history',
                    supervisorMobile: currentSupervisor
                })
            });
            const result = await response.json();

            container.innerHTML = '';
            if (result.data && result.data.length > 0) {
                result.data.forEach(item => {
                    const date = new Date(item.date).toLocaleDateString('ar-SA');
                    container.innerHTML += `
                        <div class="history-item">
                            <div style="display:flex; justify-content:space-between;">
                                <span>ğŸ‘¤ ${item.customer}</span>
                                <strong>${item.amount} SAR</strong>
                            </div>
                            <div style="font-size:12px; color:#666; margin:5px 0;">ğŸ“… ${date}</div>
                            <a href="${item.url}" target="_blank">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ â†—</a>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = '<p style="text-align:center; color:#888">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ø³Ø§Ø¨Ù‚Ø©.</p>';
            }
        } catch (e) {
            container.innerHTML = 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„';
        }
    }
</script>

</body>
</html>
